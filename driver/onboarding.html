<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver onboarding | No 5 Tyre</title>
  <link rel="stylesheet" href="../styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { theme: { extend: { colors: { safety: '#fede00' } } } }</script>
</head>
<body class="bg-zinc-900 text-zinc-200 antialiased min-h-screen page-loaded">
  <header class="bg-zinc-900 border-b border-zinc-700">
    <div class="max-w-2xl mx-auto px-4 py-6">
      <h1 class="text-xl font-bold text-white">Driver onboarding</h1>
      <p class="text-zinc-400 text-sm mt-1">Sign up to receive job assignments and payouts via Stripe.</p>
    </div>
  </header>

  <main class="max-w-2xl mx-auto px-4 py-8">
    <div id="step-form" class="rounded-2xl border border-zinc-700 bg-zinc-800/50 p-6 space-y-6">
      <h2 class="text-lg font-semibold text-white">Your details</h2>
      <form id="driver-register-form" class="space-y-4">
        <div>
          <label for="name" class="block text-sm font-medium text-zinc-300 mb-1">Full name *</label>
          <input type="text" id="name" name="name" required class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="John Smith">
        </div>
        <div>
          <label for="email" class="block text-sm font-medium text-zinc-300 mb-1">Email *</label>
          <input type="email" id="email" name="email" required class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="john@example.com">
        </div>
        <div>
          <label for="phone" class="block text-sm font-medium text-zinc-300 mb-1">Phone *</label>
          <input type="tel" id="phone" name="phone" required class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="07895 859505">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-zinc-300 mb-1">Password *</label>
          <input type="password" id="password" name="password" required minlength="8" class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="Min 8 characters">
        </div>
        <div>
          <label for="pin" class="block text-sm font-medium text-zinc-300 mb-1">PIN (4–6 digits, optional)</label>
          <input type="password" id="pin" name="pin" pattern="[0-9]{4,6}" maxlength="6" inputmode="numeric" class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="Quick login on mobile">
        </div>
        <hr class="border-zinc-700">
        <h3 class="text-base font-semibold text-white">Driving licence</h3>
        <div>
          <label for="license_number" class="block text-sm font-medium text-zinc-300 mb-1">Licence number *</label>
          <input type="text" id="license_number" name="license_number" required class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="SMITH801010AB5CE">
        </div>
        <hr class="border-zinc-700">
        <h3 class="text-base font-semibold text-white">Van / vehicle</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="van_make" class="block text-sm font-medium text-zinc-300 mb-1">Van make & model *</label>
            <input type="text" id="van_make" name="van_make" required class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="Ford Transit">
          </div>
          <div>
            <label for="van_reg" class="block text-sm font-medium text-zinc-300 mb-1">Registration *</label>
            <input type="text" id="van_reg" name="van_reg" required class="w-full px-4 py-3 rounded-lg bg-zinc-700 border border-zinc-600 text-white focus:border-safety focus:outline-none" placeholder="AB12 CDE">
          </div>
        </div>
        <p id="form-status" class="text-sm hidden"></p>
        <button type="submit" id="submit-btn" class="w-full px-4 py-3 bg-safety text-zinc-900 font-bold rounded-lg hover:bg-[#e5c900] focus:outline-none focus:ring-2 focus:ring-safety">
          Create account & set up payouts
        </button>
      </form>
    </div>

    <!-- Embedded Stripe Connect onboarding (shown after form) -->
    <div id="step-stripe" class="hidden rounded-2xl border border-zinc-700 bg-zinc-800/50 p-6">
      <h2 class="text-lg font-semibold text-white mb-2">Set up your payout account</h2>
      <p class="text-white text-sm mb-4">Complete the form below to receive payments. All done on this page.</p>
      <div id="connect-onboarding-container" class="min-h-[400px]"></div>
    </div>
  </main>

  <script>
  (function() {
    var form = document.getElementById('driver-register-form');
    var status = document.getElementById('form-status');
    var stepForm = document.getElementById('step-form');
    var stepStripe = document.getElementById('step-stripe');
    var container = document.getElementById('connect-onboarding-container');

    function showError(msg) {
      status.textContent = msg;
      status.classList.remove('hidden', 'text-green-400');
      status.classList.add('text-red-400');
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      status.classList.add('hidden');
      var btn = document.getElementById('submit-btn');
      btn.disabled = true;
      var payload = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.replace(/\D/g, ''),
        password: document.getElementById('password').value,
        license_number: document.getElementById('license_number').value.trim(),
        van_make: document.getElementById('van_make').value.trim(),
        van_reg: document.getElementById('van_reg').value.trim().toUpperCase().replace(/\s/g, '')
      };
      var pin = document.getElementById('pin').value;
      if (pin) payload.pin = pin;
      fetch('api/register.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(function(r) {
        return r.json().then(function(d) {
          if (!r.ok) throw new Error(d.error || 'Something went wrong.');
          return d;
        }).catch(function(e) {
          if (e.message && e.message !== 'Unexpected token') throw e;
          throw new Error(r.status >= 500 ? 'Server error. Please try again or call 07895 859505.' : 'Something went wrong.');
        });
      }).then(function(d) {
        if (d.accountId && d.driverId) {
          stepForm.classList.add('hidden');
          stepStripe.classList.remove('hidden');
          startEmbeddedOnboarding(d.accountId, d.driverId);
        } else {
          showError(d.error || 'Something went wrong.');
          btn.disabled = false;
        }
      }).catch(function(e) {
        showError(e.message || 'Network error. Try again or call 07895 859505.');
        btn.disabled = false;
      });
    });

    function startEmbeddedOnboarding(accountId, driverId) {
      fetch('api/config.php').then(function(r) { return r.json(); }).then(function(cfg) {
        var pk = (cfg.stripePublishableKey || '').trim();
        if (!pk) {
          container.innerHTML = '<p class="text-red-400">Stripe not configured. Contact support.</p>';
          return;
        }
        container.innerHTML = '<p class="text-zinc-400">Loading payout form…</p>';
        var fetchClientSecret = function() {
          return fetch('api/account-session.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ account: accountId })
          }).then(function(r) { return r.json(); }).then(function(d) {
            if (d.client_secret) return d.client_secret;
            throw new Error(d.error || 'Could not load payout form');
          });
        };
        window.StripeConnect = window.StripeConnect || {};
        window.StripeConnect.onLoad = function() {
          var instance = window.StripeConnect.init({
            publishableKey: pk,
            fetchClientSecret: fetchClientSecret,
            appearance: { variables: { colorPrimary: '#fede00' } }
          });
          var onboarding = instance.create('account-onboarding');
          onboarding.setOnExit(function() {
            window.location.href = 'connect-return.php?state=' + encodeURIComponent(driverId);
          });
          container.innerHTML = '';
          container.appendChild(onboarding);
        };
        var script = document.createElement('script');
        script.src = 'https://connect-js.stripe.com/v1.0/connect.js';
        script.async = true;
        script.onerror = function() {
          container.innerHTML = '<p class="text-red-400">Failed to load. Check your connection.</p>';
        };
        document.head.appendChild(script);
      });
    }
  })();
  </script>
</body>
</html>
